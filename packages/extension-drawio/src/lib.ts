import { ctx, getExtensionBasePath } from '@yank-note/runtime-api'
import type { Doc } from '@yank-note/runtime-api/types/types/share/types'
import i18n from './i18n'

export const FILE_XML = '<mxfile host="embed.diagrams.net" modified="2022-01-11T08:20:21.828Z" agent="5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36" etag="EEjUkbc3rjhjUWmDhpO0" version="16.2.4" type="embed"><diagram id="inMPcjYvnmvmxzhDKLPN" name="Page-1">jZJNb4QgEIZ/DXeV1N1ea+3uYZsePPRMZCokIIbFVfvri2XwI6ZJL2bmmRl55wVCCz1eLOvEu+GgSJbwkdBXkmU5PfvvDKYAzgkNoLGSB5SuoJLfgDBB2ksO912jM0Y52e1hbdoWardjzFoz7Nu+jNqf2rEGDqCqmTrST8mdwC2y08qvIBsRT07z51DRLDbjJnfBuBk2iJaEFtYYFyI9FqBm76IvYe7tj+oizELr/jOQhYEHUz3udi1vtw8U56a4sTV9y2EeSgh9GYR0UHWsnquDv2LPhNPKZ6kPjyJQ1wOsg3GDUNQFjAZnJ9+C1cUgfCHpE+bD6ncae8TG6xwZwytull+vLvgAjYjpavhvbfNqafkD</diagram></mxfile>'
export const FILE_SVG = '<?xml version="1.0" encoding="UTF-8"?>\n<!-- Do not edit this file with editors other than draw.io -->\n<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">\n<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="121px" height="61px" viewBox="-0.5 -0.5 121 61" content="&lt;mxfile host=&quot;localhost&quot; modified=&quot;2024-01-24T07:33:40.708Z&quot; agent=&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) yank.note/3.66.1 Chrome/108.0.5359.215 Electron/22.3.25 Safari/537.36&quot; etag=&quot;00OLX_2NWKAxaxqheT__&quot; version=&quot;23.0.0&quot; type=&quot;embed&quot; scale=&quot;1&quot; border=&quot;0&quot;&gt;&#10;  &lt;diagram id=&quot;inMPcjYvnmvmxzhDKLPN&quot; name=&quot;Page-1&quot;&gt;&#10;    &lt;mxGraphModel dx=&quot;1057&quot; dy=&quot;835&quot; grid=&quot;1&quot; gridSize=&quot;10&quot; guides=&quot;1&quot; tooltips=&quot;1&quot; connect=&quot;1&quot; arrows=&quot;1&quot; fold=&quot;1&quot; page=&quot;1&quot; pageScale=&quot;1&quot; pageWidth=&quot;827&quot; pageHeight=&quot;1169&quot; math=&quot;0&quot; shadow=&quot;0&quot;&gt;&#10;      &lt;root&gt;&#10;        &lt;mxCell id=&quot;0&quot; /&gt;&#10;        &lt;mxCell id=&quot;1&quot; parent=&quot;0&quot; /&gt;&#10;        &lt;mxCell id=&quot;2&quot; value=&quot;HELLO&quot; style=&quot;rounded=0;whiteSpace=wrap;html=1;&quot; parent=&quot;1&quot; vertex=&quot;1&quot;&gt;&#10;          &lt;mxGeometry x=&quot;220&quot; y=&quot;150&quot; width=&quot;120&quot; height=&quot;60&quot; as=&quot;geometry&quot; /&gt;&#10;        &lt;/mxCell&gt;&#10;      &lt;/root&gt;&#10;    &lt;/mxGraphModel&gt;&#10;  &lt;/diagram&gt;&#10;&lt;/mxfile&gt;&#10;" style="background-color: rgb(255, 255, 255);"><defs/><rect fill="#ffffff" width="100%" height="100%" x="0" y="0"/><g><rect x="0" y="0" width="120" height="60" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 30px; margin-left: 1px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">HELLO</div></div></div></foreignObject><image x="1" y="23.5" width="118" height="17" xlink:href="data:image/png;base64,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"/></switch></g></g></svg>'
export const FILE_PNG = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHkAAAA9CAYAAACJM8YzAAAAAXNSR0IArs4c6QAAA0B0RVh0bXhmaWxlACUzQ214ZmlsZSUyMGhvc3QlM0QlMjJlbWJlZC5kaWFncmFtcy5uZXQlMjIlMjBtb2RpZmllZCUzRCUyMjIwMjItMDEtMTFUMDglM0EyNCUzQTEyLjA2NFolMjIlMjBhZ2VudCUzRCUyMjUuMCUyMChNYWNpbnRvc2glM0IlMjBJbnRlbCUyME1hYyUyME9TJTIwWCUyMDEwXzE1XzcpJTIwQXBwbGVXZWJLaXQlMkY1MzcuMzYlMjAoS0hUTUwlMkMlMjBsaWtlJTIwR2Vja28pJTIwQ2hyb21lJTJGOTcuMC40NjkyLjcxJTIwU2FmYXJpJTJGNTM3LjM2JTIyJTIwZXRhZyUzRCUyMlZielhWTkZVWXg4d1B1S1M2dGdRJTIyJTIwdmVyc2lvbiUzRCUyMjE2LjIuNCUyMiUyMHR5cGUlM0QlMjJlbWJlZCUyMiUzRSUzQ2RpYWdyYW0lMjBpZCUzRCUyMmluTVBjall2bm12bXh6aERLTFBOJTIyJTIwbmFtZSUzRCUyMlBhZ2UtMSUyMiUzRWpaSk5iNFFnRUlaJTJGRFhlVjFOMWVhJTJCM3VZWnNlUFBSTVpDb2tJSWJGVmZ2cmkyWHdJNlpKTDJibW1SbDU1d1ZDQ3oxZUxPdkV1JTJCR2dTSmJ3a2RCWGttVTVQZnZ2REtZQXpna05vTEdTQjVTdW9KTGZnREJCMmtzTzkxMmpNMFk1MmUxaGJkb1dhcmRqekZvejdOdSUyQmpOcWYyckVHRHFDcW1UclNUOG1kd0MyeTA4cXZJQnNSVDA3ejUxRFJMRGJqSm5mQnVCazJpSmFFRnRZWUZ5STlGcUJtNzZJdlllN3RqJTJCb2l6RUxyJTJGak9RaFlFSFV6M3VkaTF2dHc4VTU2YTRzVFY5eTJFZVNnaDlHWVIwVUhXc25xdUR2MkxQaE5QS1o2a1BqeUpRMXdPc2czR0RVTlFGakFabko5JTJCQzFjVWdmQ0hwRSUyQmJENm5jYWU4VEc2eHdad3l0dWxsJTJCdkx2Z0FqWWpwYXZodmJmTnFhZmtEJTNDJTJGZGlhZ3JhbSUzRSUzQyUyRm14ZmlsZSUzRTVX5JYAAAOnSURBVHhe7do9KLVhGAfw/4kkIhkoRfmaFEWUJIswyGxQFrEYLCgiBhHKUQZlowxSFgYZGJAM7IqEwccgH4uPeLvuXqfzvIec+015rnP/7zKd6xzX/f+d67mfp04AwDu4YjqBgCC/v9M5VpUDgQCIHKu6f/dF5BgHlu0RmcgOJODAFjnJRHYgAQe2yEkmsgMJOLBFTjKRHUjAgS1ykonsQAIObJGTTGQHEnBgi5xkIjuQgANb5CQT2YEEHNgiJ5nIDiTgwBY5yUR2IAEHtshJjhL57e0Np6enSExMRFZWVpTv8keZGuT8/Hz09vaivb09lNzBwQHKyspwc3OD5ORkJCUlfZrq0tISSktLUVBQgJOTE+Tm5nrqFhYW0NfXh/Pz84j3y+/Rx8bGMDo6ioeHB/N6SkoKJiYm0NHR4Q/Fb7pQhdzT0+MJ9gP5+vraIMvfysoKSkpKPNvOyMjA5eWlQT4+PkZeXp7n9fn5eXR3d+Pq6ioiroGBAUxPT2NxcRH19fWQiV5eXkZLSwumpqbQ1dXle+iYQ97f30d5eXlE8IJri3x7e4v09HTMzc2hra3N85mDg4MIBoO4u7szv2v281KFXFRUhKqqqlCeFxcXmJmZQfgkDw8Po7CwMFQjG2xubjYTbIu8t7eHyspKnJ2dITs72+O4vb2N6upqM/1ypfDzUoUcHx8POZs/lkyaQIQjy6U4LS0tVBMXFweZ7v9BXltbQ2NjI+7v7805HL52d3fNF+6zM95v4KqQozmTf/JyfXh4aG7YNjY2UFtb67EbHx83N4JPT09ISEjwm6unHyID+OrG6/Hx0Uyw3JQJaviqq6vDy8sLNjc3fQ0szcUcsjwOFRcXe4KX51q5QZIzeXV11XO+ZmZmYn19HZ2dnZBzNnzJ0TA5OYmhoSHI5zY1NeH19RWzs7Po7+/H1tYWampqiPxTCUjgX12uv3tOlpuzhoYGg/zvkudf+RK0trZGvLazs4OKigqMjIwY6I8lN1qCLtOsYamZ5N8O8/n5GUdHR0hNTUVOTs5vt2P1/4lsFZfOYiLrdLPqmshWceksJrJON6uuiWwVl85iIut0s+qayFZx6Swmsk43q66JbBWXzmIi63Sz6prIVnHpLCayTjerrolsFZfOYiLrdLPqmshWceksJrJON6uuiWwVl85iIut0s+qayFZx6Swmsk43q66JbBWXzmIi63Sz6prIVnHpLCayTjerrolsFZfO4hCyzvbZdbQJ/AFkdDUfctJpxQAAAABJRU5ErkJggg=='

export function getEditorPath (path?: string) {
  return ctx.utils.path.join(getExtensionBasePath(__EXTENSION_ID__), 'editor', path || '')
}

export function buildEditorUrl (fileOrBase64Url: Doc | string) {
  const search = typeof fileOrBase64Url !== 'string'
    ? new URLSearchParams({ name: fileOrBase64Url.name, path: fileOrBase64Url.path, repo: fileOrBase64Url.repo })
    : new URLSearchParams({ base64ContentUrl: fileOrBase64Url })
  return getEditorPath('index.html') + '?' + search.toString()
}

export async function createDrawioFile (node: Doc) {
  const currentPath = node.path
  const fileExt = ctx.lib.vue.ref<'.drawio' | '.drawio.png' | '.drawio.svg'>('.drawio')

  const { h } = ctx.lib.vue

  let filename = await ctx.ui.useModal().input({
    title: i18n.t('create-drawio-file'),
    hint: ctx.i18n.t('document.create-dialog.hint'),
    component: h('div', [
      ctx.i18n.t('document.current-path', currentPath),
      h('div', { style: 'margin: 8px 0' }, [
        i18n.t('file-type'),
        h('label', { style: 'margin-right: 8px' }, [h('input', { type: 'radio', name: 'type', value: '.drawio', checked: fileExt.value === '.drawio', onChange: () => { fileExt.value = '.drawio' } }), '.drawio']),
        h('label', { style: 'margin: 0 8px' }, [h('input', { type: 'radio', name: 'type', value: '.drawio.png', checked: fileExt.value === '.drawio.png', onChange: () => { fileExt.value = '.drawio.png' } }), '.drawio.png']),
        h('label', { style: 'margin: 0 8px' }, [h('input', { type: 'radio', name: 'type', value: '.drawio.svg', checked: fileExt.value === '.drawio.svg', onChange: () => { fileExt.value = '.drawio.svg' } }), '.drawio.svg']),
      ]),
    ]),
    value: 'new-diagram',
    select: true
  })

  if (!filename) {
    return
  }

  if (!filename.endsWith(fileExt.value)) {
    filename = filename.replace(/\/$/, '') + fileExt.value
  }

  const path = ctx.utils.path.join(currentPath, filename)

  if (!path) {
    throw new Error('Need Path')
  }

  const file: Doc = { repo: node.repo, path: path, type: 'file', name: filename, contentHash: 'new' }
  let isBase64: boolean
  let content: string

  if (fileExt.value === '.drawio.png') {
    isBase64 = true
    content = FILE_PNG
  } else if (fileExt.value === '.drawio.svg') {
    isBase64 = false
    content = FILE_SVG
  } else {
    isBase64 = false
    content = FILE_XML
  }

  try {
    await ctx.api.writeFile(file, content, isBase64)
    ctx.tree.refreshTree()
    ctx.doc.switchDoc(file)
    ctx.editor.switchEditor('drawio')
  } catch (error: any) {
    ctx.ui.useToast().show('warning', error.message)
    console.error(error)
  }
}
